<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手書き数字認識 AI</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f4f4f4; touch-action: none; }
        h1 { margin-bottom: 10px; }
        #canvas-container {
            margin: 0 auto;
            border: 5px solid #333;
            display: inline-block;
            background-color: black; /* AIの学習データに合わせて黒背景 */
        }
        canvas { display: block; cursor: crosshair; }
        .controls { margin-top: 15px; }
        button {
            padding: 10px 20px; font-size: 1.2rem; margin: 0 10px;
            cursor: pointer; border-radius: 5px; border: none;
        }
        .btn-predict { background-color: #28a745; color: white; }
        .btn-clear { background-color: #dc3545; color: white; }
        #result {
            font-size: 2rem; font-weight: bold; margin-top: 20px; min-height: 60px; color: #333;
        }
    </style>
</head>
<body>

    <h1>AI 手書き数字認識</h1>
    <p>黒い枠の中に大きく数字(0-9)を書いてね</p>

    <div id="canvas-container">
        <canvas id="drawingCanvas" width="280" height="280"></canvas>
    </div>

    <div class="controls">
        <button class="btn-predict" onclick="predictDigit()">判定！</button>
        <button class="btn-clear" onclick="clearCanvas()">消す</button>
    </div>

    <div id="result">ここに結果が出ます</div>

    <script>
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        // --- 初期設定 ---
        // 背景を黒で塗りつぶす（これがないと背景が透明になり、AIが誤認識する）
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ペンの設定（白文字）
        ctx.strokeStyle = "white";
        ctx.lineWidth = 20; // 太めのペン
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        // --- マウス操作イベント ---
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // --- スマホ(タッチ)操作イベント ---
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // スクロール防止
            startDrawing(e.touches[0]);
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e.touches[0]);
        });
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            draw(e); // 点だけでも描画されるように
        }

        function draw(e) {
            if (!isDrawing) return;
            
            // キャンバス内の座標を計算
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath(); // パスをリセット
        }

        function clearCanvas() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            document.getElementById('result').innerText = "ここに結果が出ます";
        }

        async function predictDigit() {
            // キャンバスの内容を画像データ(Base64文字列)として取得
            const imageData = canvas.toDataURL('image/png');

            document.getElementById('result').innerText = "考え中...";

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                const data = await response.json();
                
                const resultText = `答え: ${data.prediction} (自信: ${data.confidence.toFixed(1)}%)`;
                document.getElementById('result').innerText = resultText;
            } catch (err) {
                console.error(err);
                document.getElementById('result').innerText = "エラーが発生しました";
            }
        }
    </script>
</body>
</html>